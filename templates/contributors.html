{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container">
    <header class="page-header">
        <h1>Browse Contributors</h1>
        <p>Discover organizations and developers sharing SELinux policies</p>
    </header>
    
    <!-- Search and Filters -->
    <div class="search-section">
        <div class="search-box">
            <input type="text" id="search-input" placeholder="Search contributors..." class="search-input">
            <button id="search-btn" class="btn btn-primary">Search</button>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label>Sort by:</label>
                <select id="sort-filter">
                    <option value="name">Name (A-Z)</option>
                    <option value="-policy_count">Most Policies</option>
                    <option value="-download_count">Most Downloads</option>
                    <option value="-created_at">Recently Added</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>
                    <input type="checkbox" id="verified-filter">
                    Verified only
                </label>
            </div>
        </div>
    </div>
    
    <!-- Results -->
    <div id="results-container">
        <div class="results-header">
            <span id="results-count">Loading...</span>
        </div>
        
        <div id="contributors-grid" class="contributors-grid">
            <!-- Will be populated via JavaScript -->
        </div>
        
        <div id="pagination" class="pagination">
            <!-- Will be populated via JavaScript -->
        </div>
    </div>
</div>

<style>
.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 40px 20px;
}

.page-header {
    text-align: center;
    margin-bottom: 40px;
    padding: 30px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.page-header h1 {
    font-size: 2.5rem;
    color: #333;
    margin-bottom: 10px;
}

.page-header p {
    color: #666;
    font-size: 1.1rem;
}

.search-section {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 40px;
}

.search-box {
    display: flex;
    gap: 15px;
    margin-bottom: 25px;
}

.search-input {
    flex: 1;
    padding: 12px 20px;
    border: 2px solid #e0e0e0;
    border-radius: 5px;
    font-size: 1rem;
}

.search-input:focus {
    outline: none;
    border-color: #667eea;
}

.filters {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    align-items: center;
}

.filter-group {
    display: flex;
    gap: 8px;
    align-items: center;
}

.filter-group label {
    font-weight: 500;
    color: #555;
}

.filter-group select {
    padding: 8px 12px;
    border: 2px solid #e0e0e0;
    border-radius: 5px;
    font-size: 0.95rem;
}

.results-header {
    margin-bottom: 20px;
    padding: 15px;
    background: white;
    border-radius: 5px;
    font-weight: 600;
    color: #555;
}

.contributors-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 25px;
    margin-bottom: 40px;
}

.contributor-card {
    background: white;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.contributor-card:hover {
    box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
    transform: translateY(-2px);
}

.contributor-header {
    display: flex;
    align-items: center;
    gap: 15px;
}

.contributor-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    font-weight: 700;
    flex-shrink: 0;
}

.contributor-info {
    flex: 1;
    min-width: 0;
}

.contributor-name {
    font-size: 1.3rem;
    font-weight: 700;
    color: #333;
    margin: 0 0 5px 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.verified-badge {
    color: #667eea;
    font-size: 1rem;
}

.contributor-display-name {
    color: #666;
    font-size: 0.9rem;
    margin: 0;
}

.contributor-description {
    color: #555;
    line-height: 1.6;
    font-size: 0.95rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.contributor-meta {
    display: flex;
    gap: 15px;
    font-size: 0.9rem;
    color: #666;
    padding-top: 10px;
    border-top: 1px solid #e0e0e0;
}

.contributor-meta span {
    display: flex;
    align-items: center;
    gap: 5px;
}

.contributor-links {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.contributor-link {
    padding: 8px 16px;
    background: #f5f7fa;
    border-radius: 5px;
    text-decoration: none;
    color: #667eea;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.2s ease;
}

.contributor-link:hover {
    background: #667eea;
    color: white;
}

.pagination {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 40px;
}

.page-btn {
    padding: 10px 16px;
    border: none;
    background: white;
    color: #667eea;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
}

.page-btn:hover {
    background: #667eea;
    color: white;
}

.page-btn.active {
    background: #667eea;
    color: white;
}

.page-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-primary {
    background: #667eea;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 5px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-primary:hover {
    background: #5568d3;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #666;
}

.error {
    background: #fee;
    color: #c33;
    padding: 20px;
    border-radius: 5px;
    margin-bottom: 20px;
}

@media (max-width: 768px) {
    .contributors-grid {
        grid-template-columns: 1fr;
    }
    
    .filters {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-box {
        flex-direction: column;
    }
}
</style>

<script>
let currentPage = 1;
let currentFilters = {
    search: '',
    sort: 'name',
    verified: false
};

async function loadContributors(page = 1) {
    const resultsContainer = document.getElementById('contributors-grid');
    const resultsCount = document.getElementById('results-count');
    
    resultsContainer.innerHTML = '<div class="loading">Loading contributors...</div>';
    
    try {
        // Build API URL with filters
        let url = `/api/v3/contributors/?page=${page}&limit=12`;
        
        if (currentFilters.search) {
            url += `&search=${encodeURIComponent(currentFilters.search)}`;
        }
        
        if (currentFilters.sort) {
            url += `&ordering=${currentFilters.sort}`;
        }
        
        if (currentFilters.verified) {
            url += `&is_verified=true`;
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.results && data.results.length > 0) {
            resultsCount.textContent = `${data.count} contributor${data.count !== 1 ? 's' : ''} found`;
            displayContributors(data.results);
            createPagination(data.count, page);
        } else {
            resultsCount.textContent = 'No contributors found';
            resultsContainer.innerHTML = '<div class="loading">No contributors match your search criteria.</div>';
        }
    } catch (error) {
        console.error('Error loading contributors:', error);
        resultsContainer.innerHTML = '<div class="error">Error loading contributors. Please try again.</div>';
    }
}

function displayContributors(contributors) {
    const grid = document.getElementById('contributors-grid');
    grid.innerHTML = '';
    
    contributors.forEach(contributor => {
        const card = document.createElement('div');
        card.className = 'contributor-card';
        
        const initial = contributor.name.charAt(0).toUpperCase();
        const verifiedBadge = contributor.is_verified ? '<span class="verified-badge" title="Verified">‚úì</span>' : '';
        
        card.innerHTML = `
            <div class="contributor-header">
                <div class="contributor-avatar">${initial}</div>
                <div class="contributor-info">
                    <h3 class="contributor-name">
                        ${contributor.name}
                        ${verifiedBadge}
                    </h3>
                    ${contributor.display_name ? `<p class="contributor-display-name">${contributor.display_name}</p>` : ''}
                </div>
            </div>
            
            ${contributor.description ? `<p class="contributor-description">${contributor.description}</p>` : ''}
            
            <div class="contributor-meta">
                <span>üì¶ ${contributor.policy_count || 0} ${contributor.policy_count === 1 ? 'policy' : 'policies'}</span>
                <span>‚¨áÔ∏è ${contributor.download_count || 0} downloads</span>
            </div>
            
            <div class="contributor-links">
                <a href="/api/_ui/v1/contributors/${contributor.name}/" class="contributor-link">
                    View Policies ‚Üí
                </a>
                ${contributor.website ? `<a href="${contributor.website}" target="_blank" class="contributor-link">üåê Website</a>` : ''}
            </div>
        `;
        
        grid.appendChild(card);
    });
}

function createPagination(totalCount, currentPage) {
    const pagination = document.getElementById('pagination');
    const pageSize = 12;
    const totalPages = Math.ceil(totalCount / pageSize);
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    pagination.innerHTML = '';
    
    // Previous button
    const prevBtn = document.createElement('button');
    prevBtn.className = 'page-btn';
    prevBtn.textContent = '‚Üê Previous';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => {
        if (currentPage > 1) {
            loadContributors(currentPage - 1);
            currentPage--;
        }
    };
    pagination.appendChild(prevBtn);
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = 'page-btn' + (i === currentPage ? ' active' : '');
        pageBtn.textContent = i;
        pageBtn.onclick = () => {
            loadContributors(i);
            currentPage = i;
        };
        pagination.appendChild(pageBtn);
    }
    
    // Next button
    const nextBtn = document.createElement('button');
    nextBtn.className = 'page-btn';
    nextBtn.textContent = 'Next ‚Üí';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => {
        if (currentPage < totalPages) {
            loadContributors(currentPage + 1);
            currentPage++;
        }
    };
    pagination.appendChild(nextBtn);
}

// Event listeners
document.addEventListener('DOMContentLoaded', () => {
    loadContributors(1);
    
    // Search button
    document.getElementById('search-btn').addEventListener('click', () => {
        currentFilters.search = document.getElementById('search-input').value;
        currentPage = 1;
        loadContributors(1);
    });
    
    // Search on Enter key
    document.getElementById('search-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            currentFilters.search = document.getElementById('search-input').value;
            currentPage = 1;
            loadContributors(1);
        }
    });
    
    // Sort filter
    document.getElementById('sort-filter').addEventListener('change', (e) => {
        currentFilters.sort = e.target.value;
        currentPage = 1;
        loadContributors(1);
    });
    
    // Verified filter
    document.getElementById('verified-filter').addEventListener('change', (e) => {
        currentFilters.verified = e.target.checked;
        currentPage = 1;
        loadContributors(1);
    });
});
</script>
{% endblock %}
