{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container">
    <header class="page-header">
        <h1>Browse Policies</h1>
        <p>Discover and explore SELinux policies from the community</p>
    </header>
    
    <!-- Search and Filters -->
    <div class="search-section">
        <div class="search-box">
            <input type="text" id="search-input" placeholder="Search policies..." class="search-input">
            <button id="search-btn" class="btn btn-primary">Search</button>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label>Contributor:</label>
                <select id="contributor-filter">
                    <option value="">All Contributors</option>
                    <!-- Will be populated via API -->
                </select>
            </div>
            
            <div class="filter-group">
                <label>Tags:</label>
                <select id="tags-filter" multiple>
                    <!-- Will be populated via API -->
                </select>
            </div>
            
            <div class="filter-group">
                <label>
                    <input type="checkbox" id="deprecated-filter">
                    Show deprecated
                </label>
            </div>
            
            <div class="filter-group">
                <label>Sort by:</label>
                <select id="sort-filter">
                    <option value="-updated_at">Recently Updated</option>
                    <option value="-download_count">Most Downloads</option>
                    <option value="name">Name (A-Z)</option>
                    <option value="-relevance">Relevance</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Results -->
    <div id="results-container">
        <div class="results-header">
            <span id="results-count">Loading...</span>
        </div>
        
        <div id="policies-grid" class="policies-grid">
            <!-- Will be populated via JavaScript -->
        </div>
        
        <div id="pagination" class="pagination">
            <!-- Will be populated via JavaScript -->
        </div>
    </div>
</div>

<style>
.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 40px 20px;
}

.page-header {
    text-align: center;
    margin-bottom: 40px;
    padding: 30px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.page-header h1 {
    font-size: 2.5rem;
    color: #333;
    margin-bottom: 10px;
}

.page-header p {
    color: #666;
    font-size: 1.1rem;
}

.search-section {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 40px;
}

.search-box {
    display: flex;
    gap: 15px;
    margin-bottom: 25px;
}

.search-input {
    flex: 1;
    padding: 12px 20px;
    border: 2px solid #e0e0e0;
    border-radius: 5px;
    font-size: 1rem;
}

.search-input:focus {
    outline: none;
    border-color: #667eea;
}

.btn {
    padding: 12px 30px;
    border: none;
    border-radius: 5px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-primary {
    background: #667eea;
    color: white;
}

.btn-primary:hover {
    background: #5568d3;
}

.filters {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.filter-group label {
    display: block;
    margin-bottom: 8px;
    color: #666;
    font-weight: 500;
}

.filter-group select,
.filter-group input[type="text"] {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #e0e0e0;
    border-radius: 5px;
}

.results-header {
    margin-bottom: 20px;
    color: #666;
}

.policies-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.policy-card {
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s;
    cursor: pointer;
}

.policy-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.policy-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 15px;
}

.policy-title {
    font-size: 1.3rem;
    color: #667eea;
    margin: 0;
    font-weight: 600;
}

.policy-version {
    background: #e7e9fc;
    color: #667eea;
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 500;
}

.policy-description {
    color: #666;
    line-height: 1.6;
    margin-bottom: 20px;
}

.policy-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
    color: #999;
    margin-bottom: 15px;
    padding-top: 15px;
    border-top: 1px solid #f0f0f0;
}

.policy-tags {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.tag {
    background: #f0f0f0;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.8rem;
    color: #666;
}

.pagination {
    display: flex;
    justify-content: center;
    gap: 10px;
}

.page-btn {
    padding: 8px 16px;
    border: 1px solid #e0e0e0;
    background: white;
    border-radius: 5px;
    cursor: pointer;
}

.page-btn:hover {
    background: #f5f5f5;
}

.page-btn.active {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #999;
}
</style>

<script>
// API base URL
const API_BASE = '/api/_ui/v1';

// State
let currentPage = 1;
let currentFilters = {};

// Load policies
async function loadPolicies() {
    const resultsContainer = document.getElementById('policies-grid');
    resultsContainer.innerHTML = '<div class="loading">Loading policies...</div>';
    
    // Build query params
    const params = new URLSearchParams({
        limit: 12,
        offset: (currentPage - 1) * 12,
        ...currentFilters
    });
    
    try {
        const response = await fetch(`${API_BASE}/search/?${params}`);
        const data = await response.json();
        
        displayPolicies(data.results);
        updateResultsCount(data.count);
        updatePagination(data);
    } catch (error) {
        resultsContainer.innerHTML = '<div class="loading">Error loading policies</div>';
        console.error('Error:', error);
    }
}

// Display policies
function displayPolicies(policies) {
    const grid = document.getElementById('policies-grid');
    
    if (!policies || policies.length === 0) {
        grid.innerHTML = '<div class="loading">No policies found</div>';
        return;
    }
    
    grid.innerHTML = policies.map(policy => `
        <div class="policy-card" onclick="viewPolicy('${policy.contributor}', '${policy.name}')">
            <div class="policy-header">
                <h3 class="policy-title">${policy.contributor}.${policy.name}</h3>
                ${policy.latest_version ? `<span class="policy-version">v${policy.latest_version}</span>` : ''}
            </div>
            <p class="policy-description">${policy.description || 'No description available'}</p>
            <div class="policy-meta">
                <span>ðŸ“¥ ${policy.download_count || 0} downloads</span>
                <span>${new Date(policy.updated_at).toLocaleDateString()}</span>
            </div>
            <div class="policy-tags">
                ${(policy.tags || []).slice(0, 3).map(tag => `<span class="tag">${tag}</span>`).join('')}
            </div>
        </div>
    `).join('');
}

// Update results count
function updateResultsCount(count) {
    document.getElementById('results-count').textContent = `${count} policies found`;
}

// Update pagination
function updatePagination(data) {
    const paginationDiv = document.getElementById('pagination');
    const totalPages = Math.ceil(data.count / 12);
    
    if (totalPages <= 1) {
        paginationDiv.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // Previous button
    if (currentPage > 1) {
        html += `<button class="page-btn" onclick="changePage(${currentPage - 1})">Previous</button>`;
    }
    
    // Page numbers
    for (let i = 1; i <= Math.min(totalPages, 5); i++) {
        html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
    }
    
    // Next button
    if (currentPage < totalPages) {
        html += `<button class="page-btn" onclick="changePage(${currentPage + 1})">Next</button>`;
    }
    
    paginationDiv.innerHTML = html;
}

// Change page
function changePage(page) {
    currentPage = page;
    loadPolicies();
    window.scrollTo(0, 0);
}

// View policy detail
function viewPolicy(contributor, name) {
    window.location.href = `${API_BASE}/policies/${contributor}/${name}/`;
}

// Search
document.addEventListener('DOMContentLoaded', () => {
    // Load initial policies
    loadPolicies();
    
    // Setup search
    const searchBtn = document.getElementById('search-btn');
    const searchInput = document.getElementById('search-input');
    
    searchBtn.addEventListener('click', () => {
        currentFilters.keywords = searchInput.value;
        currentPage = 1;
        loadPolicies();
    });
    
    searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            currentFilters.keywords = searchInput.value;
            currentPage = 1;
            loadPolicies();
        }
    });
    
    // Setup filters
    document.getElementById('sort-filter').addEventListener('change', (e) => {
        currentFilters.order_by = e.target.value;
        currentPage = 1;
        loadPolicies();
    });
    
    document.getElementById('deprecated-filter').addEventListener('change', (e) => {
        if (e.target.checked) {
            currentFilters.deprecated = 'true';
        } else {
            delete currentFilters.deprecated;
        }
        currentPage = 1;
        loadPolicies();
    });
});
</script>
{% endblock %}
